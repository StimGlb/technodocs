<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="√âditeur d'article interactif - TechnoDocs"
    />
    <title>√âdition d'article | TechnoDocs</title>

    <!-- CSS du projet -->
    <link rel="stylesheet" href="/src/css/style.css" />
    <link rel="stylesheet" href="/src/css/wizard.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Styles sp√©cifiques pour le mot de passe */
      .password-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .password-prompt {
        background-color: var(--color-white);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 400px;
        width: 90%;
      }
      .password-prompt h2 {
        color: var(--color-primary-700);
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
      }
      .password-prompt input[type="password"] {
        width: calc(100% - 2rem);
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--color-gray-300);
        border-radius: 4px;
        font-size: 1rem;
      }
      .password-prompt button {
        background-color: var(--color-primary-500);
        color: var(--color-white);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s ease;
      }
      .password-prompt button:hover {
        background-color: var(--color-primary-600);
      }
      .password-prompt .error-message {
        color: var(--color-error);
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <!-- Overlay pour le mot de passe -->
    <div id="passwordOverlay" class="password-overlay">
      <div class="password-prompt">
        <h2>üîí Acc√®s s√©curis√©</h2>
        <p>Veuillez entrer le mot de passe pour acc√©der √† l'√©diteur.</p>
        <input type="password" id="passwordInput" placeholder="Mot de passe" />
        <button onclick="checkPassword()">Acc√©der</button>
        <p id="errorMessage" class="error-message" style="display: none">
          Mot de passe incorrect.
        </p>
      </div>
    </div>

    <!-- Header dynamique -->
    <div id="header-placeholder"></div>

    <main class="wizard" style="display: none">
      <!-- Le contenu principal est cach√© initialement -->

      <!-- ========== BANNI√àRE TITRE ========== -->
      <div class="wizard__banner">
        <div class="wizard__banner-icon">‚úçÔ∏è</div>
        <div class="wizard__banner-content">
          <h1 class="wizard__banner-title">√âdition d'article</h1>
          <div class="wizard__banner-skills">
            <span class="wizard__skill">Choisis √† un sujet</span>
            <span class="wizard__skill">Propose un article</span>
          </div>
        </div>
      </div>
      <!-- ========== INFO √âL√àVE ========== -->
      <div class="wizard__student-info">
        <div class="wizard__student-row">
          <div class="wizard__student-field wizard__student-field--name">
            <label for="studentName">Pr√©nom et Nom</label>
            <input
              type="text"
              id="studentName"
              data-field="studentName"
              placeholder=""
            />
          </div>
          <div class="wizard__student-field wizard__student-field--class">
            <label for="studentClass">Classe</label>
            <select id="studentClass" data-field="studentClass">
              <option value="">‚Äî S√©lectionner ‚Äî</option>
              <optgroup label="5√®me">
                <option value="505">5√®me 5</option>
                <option value="506">5√®me 6</option>
                <option value="507">5√®me 7</option>
              </optgroup>
              <optgroup label="4√®me">
                <option value="401">4√®me 1</option>
                <option value="402">4√®me 2</option>
                <option value="403">4√®me 3</option>
                <option value="404">4√®me 4</option>
                <option value="405">4√®me 5</option>
              </optgroup>
              <optgroup label="3√®me">
                <option value="302">3√®me 2</option>
                <option value="303">3√®me 3</option>
                <option value="304">3√®me 4</option>
                <option value="305">3√®me 5</option>
                <option value="306">3√®me 6</option>
                <option value="307">3√®me 7</option>
                <option value="308">3√®me 8</option>
              </optgroup>
            </select>
          </div>
          <div class="wizard__student-field wizard__student-field--date">
            <label>Date</label>
            <span
              class="wizard__date-display"
              id="projectDate"
              data-field="projectDate"
            ></span>
          </div>
        </div>
      </div>

      <!-- ========== CONTENEUR FORMULAIRE ========== -->
      <div class="wizard__container">
        <!-- Section unique pour l'√©dition d'article -->
        <section class="wizard__phase active" data-phase="1">
          <div class="wizard__phase-header">
            <div class="wizard__phase-icon">üìù</div>
            <h2 class="wizard__phase-title">R√©dige ton article</h2>
            <p class="wizard__phase-subtitle">
              Compl√®te les informations et le contenu de ton article.
            </p>
          </div>

          <!-- Champ Titre de l'article -->
          <div class="wizard__group">
            <label class="wizard__label required">Titre de l'article</label>
            <p class="wizard__hint">
              Un titre clair et accrocheur pour ton article.
            </p>
            <input
              type="text"
              class="wizard__input"
              data-field="articleTitle"
              placeholder="Ex: L'impact de l'IA sur l'√©ducation"
            />
          </div>

          <!-- Champ Cat√©gorie -->
          <div class="wizard__group">
            <label class="wizard__label required">Cat√©gorie de l'article</label>
            <select class="wizard__input" data-field="articleCategory">
              <option value="">‚Äî S√©lectionner ‚Äî</option>
              <option value="Technologie">Technologie</option>
              <option value="Science">Science</option>
              <option value="Environnement">Environnement</option>
              <option value="Soci√©t√©">Soci√©t√©</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <!-- Bo√Æte texte long -->
          <div class="wizard__group">
            <label class="wizard__label required"
              >R√©dige le texte de ton article</label
            >
            <p class="wizard__hint">
              D√©veloppe tes id√©es ici. N'h√©site pas √† structurer ton texte.
            </p>
            <textarea
              class="wizard__textarea"
              data-field="articleText"
              placeholder="Commence √† √©crire ton article ici..."
            ></textarea>
          </div>

          <!-- Bo√Æte IA (optionnel) -->
          <div class="wizard__ai-box">
            <p class="wizard__ai-title">ü§ñ Utilisation de l'IA (optionnel)</p>
            <p>
              Si tu as utilis√© une IA pour t'aider (ex: pour des id√©es, des
              reformulations), note ton prompt :
            </p>
            <textarea
              data-field="aiPrompt"
              placeholder="Ex: J'ai demand√© √† une IA de me donner des arguments pour mon article sur..."
            ></textarea>
          </div>

          <!-- Navigation (bouton Terminer seulement pour un formulaire simple) -->
          <div class="wizard__phase-nav">
            <div></div>
            <button class="btn btn--success" onclick="wizardComplete()">
              ‚úÖ Terminer
            </button>
          </div>
        </section>
      </div>

      <!-- ========== BARRE D'ACTIONS ========== -->
      <div class="wizard__actions">
        <button
          class="btn btn--secondary btn--small"
          onclick="wizardExportJSON()"
        >
          üì§ Exporter JSON
        </button>
        <button
          class="btn btn--secondary btn--small"
          onclick="document.getElementById('importInput').click()"
        >
          üì• Importer JSON
        </button>
        <input
          type="file"
          id="importInput"
          accept=".json"
          style="display: none"
          onchange="wizardImportJSON(event)"
        />
        <button
          class="btn btn--secondary btn--small"
          onclick="handleSafeReset()"
        >
          üóëÔ∏è R√©initialiser
        </button>
        <button class="btn btn--secondary btn--small" onclick="window.print()">
          üñ®Ô∏è Imprimer
        </button>
      </div>
    </main>

    <!-- Footer dynamique -->
    <div id="footer-placeholder"></div>

    <!-- ========== MODALES ========== -->

    <!-- Modal Compl√©tion -->
    <div class="wizard__modal-overlay" id="completionModal">
      <div class="wizard__modal">
        <h3 class="wizard__modal-title">üéâ F√©licitations !</h3>
        <div class="wizard__modal-content">
          <p>Tu as termin√© ton travail !</p>
          <p style="margin-top: 1rem">
            Ton article a √©t√© <strong>sauvegard√© automatiquement</strong> dans
            la base de donn√©es.
          </p>
          <p
            style="
              margin-top: 0.75rem;
              font-size: 0.875rem;
              color: var(--color-gray-500);
            "
          >
            Tu peux aussi exporter une copie locale en JSON.
          </p>
        </div>
        <div class="wizard__modal-actions">
          <button
            class="btn btn--secondary"
            onclick="wizardCloseModal('completionModal')"
          >
            Fermer
          </button>
          <button
            class="btn btn--primary"
            onclick="
              wizardExportJSON();
              wizardCloseModal('completionModal');
            "
          >
            üì§ Exporter
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Reset -->
    <div class="wizard__modal-overlay" id="resetModal">
      <div class="wizard__modal">
        <h3 class="wizard__modal-title">‚ö†Ô∏è R√©initialiser ?</h3>
        <div class="wizard__modal-content">
          <p>
            Une <strong>sauvegarde</strong> a √©t√© t√©l√©charg√©e automatiquement.
          </p>
          <p>
            Voulez-vous <strong>recommencer</strong> avec un formulaire vide ?
          </p>
        </div>
        <div class="wizard__modal-actions">
          <button
            class="btn btn--secondary"
            onclick="wizardCloseModal('resetModal')"
          >
            Annuler
          </button>
          <button
            class="btn btn--primary"
            style="background: var(--color-error)"
            onclick="wizardReset()"
          >
            üóëÔ∏è R√©initialiser
          </button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="wizard__toast" id="wizardToast">
      <span class="wizard__toast-icon"></span>
      <span class="wizard__toast-message"></span>
    </div>

    <!-- ========== SCRIPTS ========== -->
    <script type="module" src="/src/js/components.js"></script>
    <script type="module">
      // ============================================
      // CONFIGURATION FIREBASE - √Ä ADAPTER
      // ============================================
      import { WizardFirebase } from "/src/js/wizard-firebase.js";

      // Cr√©er l'instance du wizard avec Firestore
      window.wizardInstance = new WizardFirebase({
        // Nom de la collection Firestore (unique par formulaire)
        collectionName: "techno_article_editor", // Nom de collection unique

        // Intervalle d'autosave (en ms)
        autosaveInterval: 15000,

        // Champs obligatoires par phase pour marquer "completed"
        requiredFields: {
          1: [
            "studentName",
            "studentClass",
            "articleTitle",
            "articleCategory",
            "articleText",
          ],
        },

        // Callback √† la compl√©tion
        onComplete: (data) => {
          console.log("üéâ Formulaire compl√©t√©:", data);
        },

        // Callback sauvegarde r√©ussie
        onSaveSuccess: (data) => {
          console.log("‚úÖ Sauvegarde Firestore OK");
        },

        // Callback erreur de sauvegarde
        onSaveError: (error) => {
          console.error("‚ùå Erreur Firestore:", error);
        },
      });

      /**
       * S√©curise la r√©initialisation en for√ßant un export JSON
       * avant de demander la confirmation de suppression.
       */
      window.handleSafeReset = function () {
        console.log(
          "Pr√©paration de la r√©initialisation : Export de secours...",
        );

        // 1. On d√©clenche l'export JSON existant
        if (typeof wizardExportJSON === "function") {
          wizardExportJSON();
        } else if (window.wizardInstance) {
          window.wizardInstance.exportToJSON();
        }

        // 2. On affiche un petit message dans le toast pour informer l'√©l√®ve
        if (window.wizardInstance && window.wizardInstance.showToast) {
          window.wizardInstance.showToast(
            "Sauvegarde de secours t√©l√©charg√©e !",
            "success",
          );
        }

        // 3. On ouvre enfin la modale de confirmation
        wizardShowModal("resetModal");
      };

      // ============================================
      // LOGIQUE D'ACC√àS PAR MOT DE PASSE
      // ============================================
      import { CORRECT_PASSWORD } from "/src/js/wizard-config.js";

      window.checkPassword = function () {
        const passwordInput = document.getElementById("passwordInput");
        const errorMessage = document.getElementById("errorMessage");
        const passwordOverlay = document.getElementById("passwordOverlay");
        const mainContent = document.querySelector("main.wizard");

        if (passwordInput.value === CORRECT_PASSWORD) {
          passwordOverlay.style.display = "none";
          mainContent.style.display = "block";
          errorMessage.style.display = "none";
          // Initialiser le wizard apr√®s l'acc√®s
          if (window.wizardInstance) {
            window.wizardInstance.init();
          }
        } else {
          errorMessage.style.display = "block";
          passwordInput.value = ""; // Efface le mot de passe incorrect
        }
      };

      // Initialiser l'√©diteur d'article avec ses protections
      import("/src/js/article-editor.js").then((module) => {
        window.articleEditor = new module.ArticleEditor({
          onPasteBlocked: (msg) =>
            window.wizardInstance?.showToast(msg, "warning"),
        });
      });

      // Permettre l'acc√®s par la touche Entr√©e
      document
        .getElementById("passwordInput")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            event.preventDefault(); // Emp√™che le rechargement de la page
            checkPassword();
          }
        });

      // Initialiser le header/footer d√®s que le DOM est pr√™t, m√™me si le wizard est cach√©
      document.addEventListener("DOMContentLoaded", () => {
        // components.js est un module, il s'ex√©cute automatiquement.
        // S'assurer que le wizard ne s'initialise pas avant le d√©verrouillage
        // La ligne `window.wizardInstance.init();` est d√©plac√©e dans `checkPassword`
      });
    </script>
  </body>
</html>
