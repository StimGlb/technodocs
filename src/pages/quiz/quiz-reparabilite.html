<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Quiz interactif sur l'indice de r√©parabilit√©, le diagnostic de pannes et l'√©co-conception - TechnoDocs">
    <title>Quiz : Comprendre la R√©parabilit√© | TechnoDocs</title>

    <!-- CSS du projet -->
    <link rel="stylesheet" href="/src/css/style.css">
    <link rel="stylesheet" href="/src/css/wizard.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header dynamique -->
    <div id="header-placeholder"></div>

    <main class="wizard">

        <!-- ========== BANNI√àRE TITRE ========== -->
        <div class="wizard__banner">
            <div class="wizard__banner-icon">üß†</div>
            <div class="wizard__banner-content">
                <h1 class="wizard__banner-title">Quiz : Comprendre la R√©parabilit√©</h1>
                <div class="wizard__banner-skills">
                    <span class="wizard__skill">CT 2.1</span>
                    <span class="wizard__skill">CT 4.2</span>
                    <span class="wizard__skill">CS 5.6</span>
                </div>
            </div>
        </div>
        <!-- ========== INFO √âL√àVE ========== -->
        <div class="wizard__student-info">
            <div class="wizard__student-row">
                <div class="wizard__student-field wizard__student-field--name">
                    <label for="studentName">Pr√©nom et Nom</label>
                    <input type="text" id="studentName" data-field="studentName" placeholder="Ton nom complet">
                </div>
                <div class="wizard__student-field wizard__student-field--class">
                    <label for="studentClass">Classe</label>
                    <select id="studentClass" data-field="studentClass">
                        <option value="">‚Äî S√©lectionner ‚Äî</option>
                        <optgroup label="5√®me">
                            <option value="505">5√®me 5</option>
                            <option value="506">5√®me 6</option>
                            <option value="507">5√®me 7</option>
                        </optgroup>
                        <optgroup label="4√®me">
                            <option value="401">4√®me 1</option>
                            <option value="402">4√®me 2</option>
                            <option value="403">4√®me 3</option>
                            <option value="404">4√®me 4</option>
                            <option value="405">4√®me 5</option>
                        </optgroup>
                        <optgroup label="3√®me">
                            <option value="302">3√®me 2</option>
                            <option value="303">3√®me 3</option>
                            <option value="304">3√®me 4</option>
                            <option value="305">3√®me 5</option>
                            <option value="306">3√®me 6</option>
                        </optgroup>
                    </select>
                </div>
                <div class="wizard__student-field wizard__student-field--date">
                    <label>Date</label>
                    <span class="wizard__date-display" id="projectDate" data-field="projectDate"></span>
                </div>
            </div>
        </div>

        <!-- ========== PROGRESSION ========== -->
        <section class="wizard__progress">
            <div class="wizard__progress-header">
                <h2 class="wizard__progress-title">Progression</h2>
                <div class="wizard__save-indicator" id="saveIndicator">
                    <span class="wizard__save-dot"></span>
                    <span class="wizard__save-text">Auto-save</span>
                </div>
                <span class="wizard__progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="wizard__progress-bar">
                <div class="wizard__progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <!-- Navigation par phases -->
            <nav class="wizard__nav" id="phaseNav">
                <button class="wizard__nav-btn active" data-phase="1">
                    <span class="wizard__nav-number">1</span>
                    <span>Introduction</span>
                </button>
                <button class="wizard__nav-btn" data-phase="2">
                    <span class="wizard__nav-number">2</span>
                    <span>Les 5 Crit√®res</span>
                </button>
                <button class="wizard__nav-btn" data-phase="3">
                    <span class="wizard__nav-number">3</span>
                    <span>Diagnostic</span>
                </button>
                <button class="wizard__nav-btn" data-phase="4">
                    <span class="wizard__nav-number">4</span>
                    <span>Synth√®se</span>
                </button>
            </nav>
        </section>

        <!-- ========== CONTENEUR FORMULAIRE ========== -->
        <div class="wizard__container">

            <!-- ========== PHASE 1 : Introduction √† l'Indice de R√©parabilit√© ========== -->
            <section class="wizard__phase active" data-phase="1">
                <div class="wizard__phase-header">
                    <div class="wizard__phase-icon">‚ùì</div>
                    <h2 class="wizard__phase-title">Phase 1 : Introduction √† l'Indice de R√©parabilit√©</h2>
                    <p class="wizard__phase-subtitle">D√©finis l'indice de r√©parabilit√© et son contexte.</p>
                </div>

                <!-- Question 1: Qu'est-ce que l'indice de r√©parabilit√© ? -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Qu'est-ce que l'indice de r√©parabilit√© ?</label>
                    <p class="wizard__hint">D√©cris en quelques phrases ce que repr√©sente cet indice.</p>
                    <textarea class="wizard__textarea" data-field="q1_definition_indice" placeholder="L'indice de r√©parabilit√© est..."></textarea>
                </div>

                <!-- Question 2: Depuis quand est-il obligatoire en France ? -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Depuis quand est-il obligatoire en France pour certains produits ?</label>
                    <p class="wizard__hint">Pr√©cise l'ann√©e.</p>
                    <input type="text" class="wizard__input" data-field="q1_date_obligation" placeholder="Ann√©e (ex: 2021)">
                </div>

                <!-- Navigation -->
                <div class="wizard__phase-nav">
                    <div></div>
                    <button class="btn btn--primary" onclick="wizardGoToPhase(2)">Suivant ‚Üí</button>
                </div>
            </section>

            <!-- ========== PHASE 2 : Les 5 Crit√®res d'√âvaluation ========== -->
            <section class="wizard__phase" data-phase="2">
                <div class="wizard__phase-header">
                    <div class="wizard__phase-icon">üìä</div>
                    <h2 class="wizard__phase-title">Phase 2 : Les 5 Crit√®res d'√âvaluation</h2>
                    <p class="wizard__phase-subtitle">Identifie les √©l√©ments cl√©s qui composent l'indice.</p>
                </div>

                <!-- Question 3: Cite les 5 crit√®res d'√©valuation -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Cite les 5 crit√®res d'√©valuation de l'indice de r√©parabilit√©.</label>
                    <p class="wizard__hint">Un crit√®re par champ.</p>
                    <input type="text" class="wizard__input" data-field="q2_critere1" placeholder="Crit√®re 1">
                    <input type="text" class="wizard__input" data-field="q2_critere2" placeholder="Crit√®re 2" style="margin-top: 0.5rem;">
                    <input type="text" class="wizard__input" data-field="q2_critere3" placeholder="Crit√®re 3" style="margin-top: 0.5rem;">
                    <input type="text" class="wizard__input" data-field="q2_critere4" placeholder="Crit√®re 4" style="margin-top: 0.5rem;">
                    <input type="text" class="wizard__input" data-field="q2_critere5" placeholder="Crit√®re 5" style="margin-top: 0.5rem;">
                </div>

                <!-- Question 4: Quel crit√®re concerne la documentation ? -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Quel crit√®re concerne la disponibilit√© des notices et sch√©mas ?</label>
                    <input type="text" class="wizard__input" data-field="q2_critere_documentation" placeholder="Nom du crit√®re">
                </div>

                <!-- Question 5: Quel crit√®re √©value le rapport prix des pi√®ces / prix neuf ? -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Quel crit√®re √©value le rapport entre le prix des pi√®ces d√©tach√©es et le prix du produit neuf ?</label>
                    <input type="text" class="wizard__input" data-field="q2_critere_prix_pieces" placeholder="Nom du crit√®re">
                </div>

                <!-- Navigation -->
                <div class="wizard__phase-nav">
                    <button class="btn btn--secondary" onclick="wizardGoToPhase(1)">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn--primary" onclick="wizardGoToPhase(3)">Suivant ‚Üí</button>
                </div>
            </section>

            <!-- ========== PHASE 3 : Diagnostic et Maintenance ========== -->
            <section class="wizard__phase" data-phase="3">
                <div class="wizard__phase-header">
                    <div class="wizard__phase-icon">üîç</div>
                    <h2 class="wizard__phase-title">Phase 3 : Diagnostic et Maintenance</h2>
                    <p class="wizard__phase-subtitle">Comprends comment identifier et r√©soudre les pannes.</p>
                </div>

                <!-- Question 6: Quels sont les deux principaux types de pannes ? -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Quels sont les deux principaux types de pannes mentionn√©s dans le cours ?</label>
                    <p class="wizard__hint">S√©lectionne les deux types principaux.</p>
                    <div class="wizard__checkbox-group">
                        <label class="wizard__checkbox-item">
                            <input type="checkbox" data-field="q3_type_panne_materielle">
                            <span class="wizard__checkbox-label">üîß Mat√©rielles</span>
                        </label>
                        <label class="wizard__checkbox-item">
                            <input type="checkbox" data-field="q3_type_panne_logicielle">
                            <span class="wizard__checkbox-label">üíª Logicielles</span>
                        </label>
                        <label class="wizard__checkbox-item">
                            <input type="checkbox" data-field="q3_type_panne_usure">
                            <span class="wizard__checkbox-label">‚è≥ Usure</span>
                        </label>
                    </div>
                </div>

                <!-- Question 7: D√©cris la m√©thode de diagnostic d'une panne. -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° D√©cris la m√©thode de diagnostic d'une panne.</label>
                    <p class="wizard__hint">Mentionne les √©tapes cl√©s : observation, hypoth√®ses, tests, conclusion.</p>
                    <textarea class="wizard__textarea" data-field="q3_methode_diagnostic" placeholder="La m√©thode de diagnostic comprend..."></textarea>
                </div>

                <!-- Navigation -->
                <div class="wizard__phase-nav">
                    <button class="btn btn--secondary" onclick="wizardGoToPhase(2)">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn--primary" onclick="wizardGoToPhase(4)">Suivant ‚Üí</button>
                </div>
            </section>

            <!-- ========== PHASE 4 : Synth√®se et R√©flexion ========== -->
            <section class="wizard__phase" data-phase="4">
                <div class="wizard__phase-header">
                    <div class="wizard__phase-icon">üìù</div>
                    <h2 class="wizard__phase-title">Phase 4 : Synth√®se et R√©flexion</h2>
                    <p class="wizard__phase-subtitle">Exprime ta compr√©hension et tes id√©es sur la r√©parabilit√©.</p>
                </div>

                <!-- Question 8: Objectif principal de l'indice de r√©parabilit√© pour le consommateur -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Selon toi, quel est l'objectif principal de l'indice de r√©parabilit√© pour le consommateur ?</label>
                    <textarea class="wizard__textarea" data-field="q4_objectif_consommateur" placeholder="L'objectif principal est de..."></textarea>
                </div>

                <!-- Question 9: Propose une am√©lioration pour rendre un produit plus r√©parable -->
                <div class="wizard__group">
                    <label class="wizard__label required">üí° Propose une am√©lioration concr√®te pour rendre un produit (de ton choix) plus r√©parable.</label>
                    <p class="wizard__hint">Pense √† un produit que tu utilises et comment il pourrait √™tre am√©lior√©.</p>
                    <textarea class="wizard__textarea" data-field="q4_amelioration_produit" placeholder="Pour rendre un [Nom du produit] plus r√©parable, on pourrait..."></textarea>
                </div>

                <!-- Bo√Æte IA (optionnel) -->
                <div class="wizard__ai-box">
                    <p class="wizard__ai-title">ü§ñ Utilisation de l'IA (optionnel)</p>
                    <p>Si tu as utilis√© une IA pour t'aider (ex: pour des d√©finitions, des id√©es), note ton prompt :</p>
                    <textarea data-field="aiPrompt" placeholder="Ex: J'ai demand√© √† ChatGPT de me lister les √©tapes de la mod√©lisation 3D."></textarea>
                </div>

                <!-- Navigation finale -->
                <div class="wizard__phase-nav">
                    <button class="btn btn--secondary" onclick="wizardGoToPhase(3)">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn--success" onclick="wizardComplete()">‚úÖ Terminer</button>
                </div>
            </section>

        </div>

        <!-- ========== BARRE D'ACTIONS ========== -->
        <div class="wizard__actions">
            <button class="btn btn--secondary btn--small" onclick="wizardExportJSON()">üì§ Exporter JSON</button>
            <button class="btn btn--secondary btn--small" onclick="document.getElementById('importInput').click()">üì• Importer JSON</button>
            <input type="file" id="importInput" accept=".json" style="display:none" onchange="wizardImportJSON(event)">
            <button class="btn btn--secondary btn--small" onclick="handleSafeReset()">üóëÔ∏è R√©initialiser</button>
            <button class="btn btn--secondary btn--small" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        </div>
    </main>

    <!-- Footer dynamique -->
    <div id="footer-placeholder"></div>

    <!-- ========== MODALES ========== -->

    <!-- Modal Compl√©tion -->
    <div class="wizard__modal-overlay" id="completionModal">
        <div class="wizard__modal">
            <h3 class="wizard__modal-title">üéâ F√©licitations !</h3>
            <div class="wizard__modal-content">
                <p>Tu as termin√© ton travail !</p>
                <p style="margin-top:1rem">Tes r√©ponses ont √©t√© <strong>sauvegard√©es automatiquement</strong> dans la base de donn√©es.</p>
                <p style="margin-top:0.75rem;font-size:0.875rem;color:var(--color-gray-500)">
                    Tu peux aussi exporter une copie locale en JSON.
                </p>
            </div>
            <div class="wizard__modal-actions">
                <button class="btn btn--secondary" onclick="wizardCloseModal('completionModal')">Fermer</button>
                <button class="btn btn--primary" onclick="wizardExportJSON();wizardCloseModal('completionModal')">üì§ Exporter</button>
            </div>
        </div>
    </div>

    <!-- Modal Reset -->
    <div class="wizard__modal-overlay" id="resetModal">
        <div class="wizard__modal">
            <h3 class="wizard__modal-title">‚ö†Ô∏è R√©initialiser ?</h3>
            <div class="wizard__modal-content">
                <p>Une <strong>sauvegarde</strong> a √©t√© t√©l√©charg√©e automatiquement.</p>
                <p>Voulez-vous vraiment <strong>supprimer d√©finitivement</strong> vos r√©ponses de la base de donn√©es ?</p>
            </div>
            <div class="wizard__modal-actions">
                <button class="btn btn--secondary" onclick="wizardCloseModal('resetModal')">Annuler</button>
                <button class="btn btn--primary" style="background:var(--color-error)" onclick="wizardReset()">üóëÔ∏è R√©initialiser</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="wizard__toast" id="wizardToast">
        <span class="wizard__toast-icon"></span>
        <span class="wizard__toast-message"></span>
    </div>

    <!-- ========== SCRIPTS ========== -->
    <script type="module" src="/src/js/components.js"></script>
    <script type="module">
        // ============================================
        // CONFIGURATION FIREBASE - √Ä ADAPTER
        // ============================================
        import { WizardFirebase } from '/src/js/wizard-firebase.js';

        // Cr√©er l'instance du wizard avec Firestore
        window.wizardInstance = new WizardFirebase({
            // Nom de la collection Firestore (unique par formulaire)
            collectionName: 'quiz_reparabilite_v1',
            
            // L'intervalle d'autosave est maintenant g√©r√© par le debounce interne de la classe.
            
            // Champs obligatoires par phase pour marquer "completed"
            requiredFields: {
                1: [
                    'studentName',
                    'studentClass',
                    'q1_definition_indice',
                    'q1_date_obligation'
                ],
                2: [
                    'q2_critere1',
                    'q2_critere2',
                    'q2_critere3',
                    'q2_critere4',
                    'q2_critere5',
                    'q2_critere_documentation',
                    'q2_critere_prix_pieces'
                ],
                3: [
                    // Pour les checkboxes, on v√©rifie si au moins une est coch√©e.
                    // Ici, on liste les champs individuels pour que le syst√®me les v√©rifie.
                    // Le syst√®me WizardFirebase doit √™tre capable de g√©rer "au moins un de ces champs" pour les groupes de checkboxes.
                    // Pour l'exemple, on met un champ repr√©sentatif du groupe comme requis.
                    'q3_type_panne_materielle', // Assuming at least one checkbox must be checked
                    'q3_methode_diagnostic'
                ],
                4: [
                    'q4_objectif_consommateur',
                    'q4_amelioration_produit'
                ]
            },
            
            // Callback √† la compl√©tion
            onComplete: (data) => {
                console.log('üéâ Formulaire compl√©t√©:', data);
            },
            
            // Callback sauvegarde r√©ussie
            onSaveSuccess: (data) => {
                console.log('‚úÖ Sauvegarde Firestore OK');
            },
            
            // Callback erreur de sauvegarde
            onSaveError: (error) => {
                console.error('‚ùå Erreur Firestore:', error);
            }
        });
        /**
        * S√©curise la r√©initialisation en for√ßant un export JSON 
        * avant de demander la confirmation de suppression.
        */
        window.handleSafeReset = function() {
            console.log("Pr√©paration de la r√©initialisation : Export de secours...");
            
            // 1. On d√©clenche l'export JSON existant
            if (typeof wizardExportJSON === "function") {
                wizardExportJSON();
            } else if (window.wizardInstance) {
                window.wizardInstance.exportToJSON(); 
            }

            // 2. On affiche un petit message dans le toast pour informer l'√©l√®ve
            if (window.wizardInstance && window.wizardInstance.showToast) {
                window.wizardInstance.showToast("Sauvegarde de secours t√©l√©charg√©e !", "success");
            }

            // 3. On ouvre enfin la modale de confirmation
            wizardShowModal('resetModal');
        };
    </script>
</body>
</html>